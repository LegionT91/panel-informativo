
<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Panel de Noticias</title>
	<link rel="stylesheet" href="static/admin_panel/style.css">
	
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

</head>
<body>
	<div class="header">
		<div class="logo">
			<img class="logo-img" src="https://complejoprincipedegales.cl/wp-content/uploads/2023/07/Logo-sin-fondo-3-e1729003593989.png" alt="Logo Colegio" />
		</div>
		<div class="title">PANEL DE NOTICIAS</div>
<button type="button" class="btn btn-primary" id="boton" data-bs-toggle="modal" data-bs-target="#exampleModal" aria-label="Añadir noticia" title="Añadir noticia" style="width:44px;height:44px;display:flex;align-items:center;justify-content:center;border-radius:50%;">
	<!-- Icono + (SVG) -->
	<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:white;">
		<line x1="12" y1="5" x2="12" y2="19"></line>
		<line x1="5" y1="12" x2="19" y2="12"></line>
	</svg>
	<span class="visually-hidden">Añadir noticia</span>
</button>
	</div>
	<div class="news-container">
		{% if avisos %}
			{% for aviso in avisos %}
			<div class="news-card" id="aviso-{{ aviso.id }}">
				<img class="news-img" src="{{ aviso.image_url if aviso.image_url else url_for('static', filename='logo.png') }}" alt="{{ aviso.title }}" />
				<button class="close-btn" title="Eliminar noticia" data-aviso-id="{{ aviso.id }}">&times;</button>
				<div class="news-text">{{ aviso.title }}</div>
			</div>
			{% endfor %}
		{% else %}
			<div class="alert alert-info">No hay noticias registradas en la base de datos.</div>
		{% endif %}
	</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
		<h1 class="modal-title fs-5 text-center w-100" id="exampleModalLabel" style="text-align:center;">Añadir Noticia</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
	  <div class="modal-body">
				<form id="addNewsForm" method="POST" action="/panel/upload" enctype="multipart/form-data">
					<div class="mb-3">
						<label for="newsTitle" class="form-label" style="font-size:1.2em; display:block; text-align:center;">Título noticia:</label>
						<textarea class="form-control" id="newsTitle" name="title" rows="2" placeholder="Escribe el título de la noticia" required></textarea>
					</div>
					<div class="row mb-3">
						<div class="col">
							<label for="startDate" class="form-label">Fecha inicio:</label>
							<input type="datetime-local" class="form-control" id="startDate" name="fecha_inicio" required>
						</div>
						<div class="col">
							<label for="endDate" class="form-label">Fecha finalización:</label>
							<input type="datetime-local" class="form-control" id="endDate" name="fecha_fin" required>
						</div>
					</div>
					<div class="mb-3 text-center">
						<label for="newsImage" class="form-label" style="width:100%;font-size:1.3em;display:block;">Haga clic para subir una imagen</label>
						<input type="file" class="form-control" id="newsImage" name="photo" accept="image/*" style="display:none;">
						<div id="imagePreview" style="border:2px solid #ccc;border-radius:10px;padding:16px;cursor:pointer;display:inline-block;width:180px;height:140px;background:#f3f3f3;" onclick="document.getElementById('newsImage').click()">
							<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" stroke="#888" stroke-width="2" viewBox="0 0 24 24" style="margin-top:20px;">
								<rect x="3" y="3" width="18" height="18" rx="4"/>
								<circle cx="8" cy="8" r="2.5"/>
								<path d="M3 17l4-4a2 2 0 0 1 2.8 0l2.2 2.2a2 2 0 0 0 2.8 0l3.2-3.2"/>
							</svg>
							<div style="color:#888;font-size:1em;margin-top:8px;">Imagen</div>
						</div>
					</div>
				</form>
      </div>
      <div class="modal-footer">
	<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
	<button type="submit" class="btn btn-primary" form="addNewsForm">Añadir noticia</button>
      </div>
    </div>
  </div>
</div>

<script>
// Vista previa de imagen
document.addEventListener('DOMContentLoaded', function() {
	const imageInput = document.getElementById('newsImage');
	const imagePreview = document.getElementById('imagePreview');
	imageInput.addEventListener('change', function(e) {
		if (e.target.files && e.target.files[0]) {
			const reader = new FileReader();
			reader.onload = function(ev) {
				imagePreview.innerHTML = `<img src='${ev.target.result}' style='max-width:100%;max-height:100px;border-radius:8px;' />`;
			};
			reader.readAsDataURL(e.target.files[0]);
		}
	});

	// Enviar formulario: al enviar, el formulario normal POST multipart será enviado al servidor
	document.getElementById('addNewsForm').addEventListener('submit', function(e) {
		// Mostrar feedback mínimo y dejar que el navegador envíe el form
		const submitBtn = document.querySelector('#exampleModal .modal-footer button[type="submit"]');
		submitBtn.disabled = true;
		submitBtn.innerText = 'Subiendo...';
	});
});
</script>
<script>
// Función para eliminar aviso vía API
async function deleteAviso(id) {
	if (!confirm('¿Eliminar esta noticia?')) return;
	try {
		const res = await fetch(`/panel/delete/${id}`, { method: 'DELETE' });
		const data = await res.json();
		if (res.ok) {
			// Refrescar la lista desde la base de datos
			await fetchAndRenderAvisos();
			// Opcional: mostrar confirmación
			alert('Noticia eliminada');
		} else {
			alert('Error al eliminar: ' + (data.error || JSON.stringify(data)));
		}
	} catch (err) {
		alert('Error de red: ' + err);
	}
}
</script>
<script>
// Volcar avisos desde la API y renderizar el HTML en el cliente
async function fetchAndRenderAvisos() {
	try {
		const res = await fetch('/panel/avisos');
		if (!res.ok) return;
		const avisos = await res.json();
		const container = document.querySelector('.news-container');
		if (!container) return;
		if (!Array.isArray(avisos) || avisos.length === 0) {
			container.innerHTML = '<div class="alert alert-info">No hay noticias registradas en la base de datos.</div>';
			return;
		}
		const logoUrl = '{{ url_for("static", filename="logo.png") }}';
		container.innerHTML = avisos.map(aviso => {
			const img = aviso.image_url && aviso.image_url !== '' ? aviso.image_url : logoUrl;
			const escapedTitle = (aviso.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
			return `
				<div class="news-card" id="aviso-${aviso.id}">
					<img class="news-img" src="${img}" alt="${escapedTitle}" />
					<button class="close-btn" title="Eliminar noticia" onclick="deleteAviso(${aviso.id})">&times;</button>
					<div class="news-text">${escapedTitle}</div>
				</div>`;
		}).join('\n');
	} catch (err) {
		console.error('Error cargando avisos:', err);
	}
}

// Llamar al cargar y refrescar periódicamente cada 10s
document.addEventListener('DOMContentLoaded', function() {
	fetchAndRenderAvisos();
	setInterval(fetchAndRenderAvisos, 10000);
});
</script>
<script>
// Delegación de eventos para los botones de eliminar (maneja elementos generados dinámicamente)
document.addEventListener('click', function(e) {
	const btn = e.target.closest && e.target.closest('.close-btn');
	if (!btn) return;
	const id = btn.getAttribute('data-aviso-id');
	if (!id) return;
	// confirmar y llamar a la función existente
	if (confirm('¿Eliminar esta noticia?')) {
		deleteAviso(id);
	}
});
</script>
</body>
</html>
